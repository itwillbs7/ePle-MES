<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 미완성 -->
<!-- maintenanceMapper.xml -->
<mapper namespace="com.itwillbs.mapper.MaintenanceMapper">
	<!-- resultMap -->
	<resultMap type="com.itwillbs.domain.MaintenanceVO" id="main">
		<result property="code" column="code" />
		<result property="reg_date" column="reg_date" />
		<result property="emp_code" column="emp_code" />
		<result property="emp_name" column="emp_name" />

		<result property="group_id" column="group_id" />
		<result property="group_name" column="group_name" />
		<result property="code_id" column="code_id" />
		<result property="code_name" column="code_name" />

		<result property="mt_subject" column="mt_subject" />
		<result property="mt_content" column="mt_content" />
		<result property="complete" column="complete" />

		<result property="manager" column="manager" />
		<result property="manager_name" column="manager_name" />
		<result property="res_info" column="res_info" />
		<result property="res_content" column="res_content" />

		<result property="comp_date" column="comp_date" />
		<collection property="facility" resultMap="fac">
			<result property="code" column="fac_code" />
			<result property="group_id" column="fac_group_id" />
			<result property="code_id" column="fac_code_id" />
			<result property="group_name" column="fac_group_name" />
			<result property="code_name" column="fac_code_name" />
			<result property="name" column="fac_name" />
			<result property="model" column="model" />
		</collection>
		<collection property="line" resultMap="line">
			<result property="code" column="line_code" />
			<result property="name" column="line_name" />
			<result property="process" column="process" />
			<result property="place" column="place" />
			<result property="status" column="line_status" />
			<result property="note" column="note" />
		</collection>
	</resultMap>
	<resultMap type="com.itwillbs.domain.FacilityVO" id="fac">
		<result property="code" column="code" />
		<result property="group_id" column="group_id" />
		<result property="code_id" column="code_id" />
		<result property="group_name" column="group_name" />
		<result property="code_name" column="code_name" />
		<result property="name" column="name" />
		<result property="model" column="model" />
	</resultMap>
	<resultMap type="com.itwillbs.domain.LineVO" id="line">
		<result property="code" column="code" />
		<result property="name" column="name" />
		<result property="process" column="process" />
		<result property="place" column="place" />
		<result property="status" column="status" />
		<result property="note" column="note" />
	</resultMap>
	<!-- resultMap -->

	<!-- search -->
	<sql id="getSearch">
		<where>
			<choose>
				<!-- complete == true -->
				<when test="search.complete == true">
					<choose>
						<when test="search.isnull == true">
							<if test="search.isajax == true">
								AND comp_date BETWEEN DATE_SUB(NOW(), INTERVAL 1 MONTH) AND NOW()
							</if>
						</when>
						<!-- search.isnull == false -->
						<otherwise>
							<!-- searchKeyword -->
							<if
								test="search.searchKeyword neq null and search.searchKeyword.toString() neq ''">
								<choose>
									<when test="search.index == -1">
										<foreach collection="search.searchMenu" item="item"
											open="AND (" close=")" separator=" OR ">
											${item} LIKE
											'%${search.searchKeyword}%'
										</foreach>
									</when>
									<otherwise>
								<![CDATA[
									AND ${search.searchMenu[search.index]} LIKE '%${search.searchKeyword}%' 
								]]>
									</otherwise>
								</choose>
							</if>
							<!-- searchKeyword -->
							<!-- check box -->
							<if test="search.formCheck neq null">
							<![CDATA[ AND m.code LIKE IN ]]>
								<foreach collection="search.formCheck" item="item"
									index="index" open="(" close=")" separator=",">
									#{item}
								</foreach>
							</if>
							<!-- check box -->
							<!-- date -->
							<choose>
								<when
									test="search.date neq null and search.date.toString() neq ''">
							<![CDATA[
								AND m.comp_date = #{search.date}
							]]>
								</when>
								<otherwise>
									<!-- date between -->
									<choose>
										<when
											test="search.betweenDateLeft neq null and search.betweenDateLeft.toString() neq '' and search.betweenDateRight neq null and search.betweenDateRight.toString() neq ''">
									<![CDATA[
										AND m.comp_date BETWEEN 
										#{search.betweenDateLeft} AND 
										#{search.betweenDateRight} 
									]]>
										</when>
										<when
											test="search.betweenDateLeft neq null and search.betweenDateLeft.toString() neq ''">
									<![CDATA[
										AND m.comp_date >= #{search.betweenDateLeft}
									]]>
										</when>
										<when
											test="search.betweenDateRight neq null and search.betweenDateRight.toString() neq ''">
									<![CDATA[
										AND m.comp_date <= #{search.betweenDateRight}
									]]>
										</when>
									</choose>
									<!-- date between -->
								</otherwise>
							</choose>
							<!-- date -->
						</otherwise>
						<!-- search.isnull == false -->
					</choose>
				</when>
				<!-- complete == true -->
				<!-- complete == false -->
				<otherwise>
					<choose>
						<when test="search.isnull == true">
							<if test="search.isajax == true">
								AND reg_date BETWEEN DATE_SUB(NOW(), INTERVAL 1
								MONTH) AND NOW()
							</if>
						</when>
						<!-- search.isnull == false -->
						<otherwise>
							<!-- searchKeyword -->
							<if
								test="search.searchKeyword neq null and search.searchKeyword.toString() neq ''">
								<choose>
									<when test="search.index == -1">
										<foreach collection="search.searchMenu" item="item"
											open="AND (" close=")" separator=" OR ">
											${item} LIKE
											'%${search.searchKeyword}%'
										</foreach>
									</when>
									<otherwise>
								<![CDATA[
									AND ${search.searchMenu[search.index]} LIKE '%${search.searchKeyword}%' 
								]]>
									</otherwise>
								</choose>
							</if>
							<!-- searchKeyword -->
							<!-- check box -->
							<if test="search.formCheck neq null">
						<![CDATA[ AND m.code LIKE IN ]]>
								<foreach collection="search.formCheck" item="item"
									index="index" open="(" close=")" separator=",">
									#{item}
								</foreach>
							</if>
							<!-- check box -->
							<!-- date -->
							<choose>
								<when
									test="search.date neq null and search.date.toString() neq ''">
							<![CDATA[
								AND m.reg_date = #{search.date}
							]]>
								</when>
								<otherwise>
									<!-- date between -->
									<choose>
										<when
											test="search.betweenDateLeft neq null and search.betweenDateLeft.toString() neq '' and search.betweenDateRight neq null and search.betweenDateRight.toString() neq ''">
									<![CDATA[
										AND m.reg_date BETWEEN 
										#{search.betweenDateLeft} AND 
										#{search.betweenDateRight} 
									]]>
										</when>
										<when
											test="search.betweenDateLeft neq null and search.betweenDateLeft.toString() neq ''">
									<![CDATA[
										AND m.reg_date >= #{search.betweenDateLeft}
									]]>
										</when>
										<when
											test="search.betweenDateRight neq null and search.betweenDateRight.toString() neq ''">
									<![CDATA[
										AND m.reg_date <= #{search.betweenDateRight}
									]]>
										</when>
									</choose>
									<!-- date between -->
								</otherwise>
							</choose>
							<!-- date -->
						</otherwise>
						<!-- search.isnull == false -->
					</choose>
				</otherwise>
				<!-- complete == false -->
			</choose>
		</where>
	</sql>

	<!-- search -->

	<!-- select -->
	<!-- detail -->
	<select id="getMain" resultMap="main"
		resultType="com.itwillbs.domain.MaintenanceVO">
		SELECT m.code, m.reg_date,
		m.emp_code, e1.name AS emp_name,
		m.group_id, cm.group_name,
		m.code_id, cm.code_name,
		m.fac_code,
		f.group_id, cf.group_name,
		f.code_id, cf.group_name,
		f.line_code, l.name
		AS line_name,
		mt_subject, mt_content,
		m.complete,
		m.manager, e2.name AS
		manager_name,
		m.res_info, m.res_content,
		m.comp_date
		FROM FAC_MT m
		JOIN
		FAC_INFO f ON m.fac_code = f.code
		JOIN COMMON_CODE cm ON m.group_id =
		cm.group_id AND m.code_id = cm.code_id
		JOIN COMMON_CODE cf ON
		f.group_id = cf.group_id AND f.code_id =
		cf.code_id
		JOIN EMPLOYEES e1 ON
		m.emp_code = e1.code
		JOIN EMPLOYEES e2 ON m.manager = e2.code
		JOIN LINE
		l ON l.code = f.line_code
		WHERE m.code = #{code}
	</select>
	<!-- detail -->
	
	<!-- facilityInfo -->
	<select id="getFacilityInfo" resultMap="main"
		resultType="com.itwillbs.domain.MaintenanceVO">
		SELECT m.code, m.reg_date,
		m.emp_code, e1.name AS emp_name,
		m.group_id, cm.group_name,
		m.code_id, cm.code_name,
		m.fac_code,
		f.group_id, cf.group_name,
		f.code_id, cf.group_name,
		f.line_code, l.name
		AS line_name,
		mt_subject, mt_content,
		m.complete,
		m.manager, e2.name AS
		manager_name,
		m.res_info, m.res_content,
		m.comp_date
		FROM FAC_MT m
		JOIN
		FAC_INFO f ON m.fac_code = f.code
		JOIN COMMON_CODE cm ON m.group_id =
		cm.group_id AND m.code_id = cm.code_id
		JOIN COMMON_CODE cf ON
		f.group_id = cf.group_id AND f.code_id =
		cf.code_id
		JOIN EMPLOYEES e1 ON
		m.emp_code = e1.code
		JOIN EMPLOYEES e2 ON m.manager = e2.code
		JOIN LINE
		l ON l.code = f.line_code
		WHERE m.fac_code = #{code} 
		ORDER BY m.code DESC 
		LIMIT 0, 10
	</select>
	<!-- facilityInfo -->
	
	<!-- facilityInfoCount -->
	<select id="getFacilityInfoCount" resultType="int">
		SELECT count(code)
		FROM FAC_MT
		WHERE m.fac_code = #{code}
	</select>
	<!-- facilityInfoCount -->
	
	<!-- list -->
	<select id="getList" resultMap="main"
		resultType="com.itwillbs.domain.MaintenanceVO">
		SELECT m.code, m.reg_date,
		m.emp_code, e1.name AS emp_name,
		m.group_id,
		cm.group_name,
		m.code_id, cm.code_name,
		m.fac_code,
		f.group_id,
		cf.group_name,
		f.code_id, cf.group_name,
		f.line_code, l.name AS
		line_name,
		mt_subject, mt_content,
		m.complete,
		m.manager, e2.name AS
		manager_name,
		m.res_info, m.res_content,
		m.comp_date
		FROM FAC_MT m
		JOIN
		FAC_INFO f ON m.fac_code = f.code
		JOIN COMMON_CODE cm ON m.group_id =
		cm.group_id AND m.code_id = cm.code_id
		JOIN COMMON_CODE cf ON
		f.group_id = cf.group_id AND f.code_id =
		cf.code_id
		JOIN EMPLOYEES e1 ON
		m.emp_code = e1.code
		JOIN EMPLOYEES e2 ON m.manager = e2.code
		JOIN LINE
		l ON l.code = f.line_code
		<include refid="getSearch" />
		ORDER BY ${search.eng[search.activeSortCategory]} ${search.sortValue}
		LIMIT ${cri.startPage}, ${cri.pageSize}
	</select>
	<!-- list -->

	<!-- list count -->
	<select id="getListCount" resultType="int">
		SELECT count(m.code)
		FROM FAC_MT m
		JOIN FAC_INFO f ON m.fac_code =
		f.code
		JOIN COMMON_CODE cm ON m.group_id = cm.group_id AND m.code_id =
		cm.code_id
		JOIN COMMON_CODE cf ON f.group_id = cf.group_id AND
		f.code_id =
		cf.code_id
		JOIN EMPLOYEES e1 ON m.emp_code = e1.code
		JOIN
		EMPLOYEES e2 ON m.manager = e2.code
		JOIN LINE l ON l.code = f.line_code
		<include refid="getSearch" />
	</select>
	<!-- list count -->
	
	<!-- getRecentCode -->
	<select id="getRecentCode" resultType="String">
		SELECT code FROM FAC_MT WHERE code LIKE '%'||#{code}||'%' 
		ORDER BY code DESC LIMIT 0, 1
	</select>
	<!-- getRecentCode -->
	
	<!-- 일상보전 -->
	<!-- getDailyRM -->
	<select id="getDailyRM" resultMap="main"
		resultType="com.itwillbs.domain.MaintenanceVO">
		SELECT code, reg_date 
		FROM FAC_MT 
		WHERE emp_code = #{emp_code} 
		AND DATE_FORMAT(reg_date, '%Y-%m-%d') == DATE_FORMAT(NOW(), '%Y-%m-%d')
	</select>
	<!-- getDailyRM -->
	<!-- getDailyRMCount -->
	<select id="getDailyRMCount" resultType="int">
		SELECT COUNT(*) FROM FAC_MT WHERE emp_code = #{emp_code} 
		AND DATE_FORMAT(reg_date, '%Y-%m-%d') == DATE_FORMAT(NOW(), '%Y-%m-%d')
	</select>
	<!-- getDailyRMCount -->
	<!-- 일상 보전 -->	
	<!-- select -->

	<!-- insert -->
	<insert id="insertMT">
		INSERT INTO FAC_MT
		<choose>
			<when test="code_id eq '000'">
				(code, reg_date, emp_code, fac_code, group_id,
				code_id, mt_subject, mt_content, complete) VALUES
				(#{code}, now(),
				#{emp_code}, #{fac_code}, #{group_id}, #{code_id},
				#{mt_subject},
				#{mt_content}, TRUE)
			</when>
			<otherwise>
				(code, reg_date, emp_code, fac_code, group_id, code_id,
				mt_subject, mt_content) VALUES
				(#{code}, now(), #{emp_code},
				#{fac_code}, #{group_id}, #{code_id},
				#{mt_subject}, #{mt_content})
			</otherwise>
		</choose>
	</insert>
	<!-- insert -->

	<!-- update -->
	<!-- emp -->
	<update id="updateMT">
		UPDATE FAC_MT
		<set>
			group_id = #{group_id}, code_id = #{code_id}, mt_subject =
			#{mt_subject}, mt_content = #{mt_content}
		</set>
		<where>
			code = #{code}
		</where>
	</update>

	<!-- manager -->
	<update id="updateResult">
		UPDATE FAC_MT
		<set>
			manager = #{manager}, #{res_info} = #{res_info}, #{res_content} =
			#{res_content}, comp_date = NOW(), complete = TRUE
		</set>
		<where>
			code = #{code} and code NOT LIKE 'DM%'
		</where>
	</update>
	<!-- update -->

	<!-- delete -->
	<delete id="deleteMT">
		DELETE FROM FAC_MT
		<where>
			<![CDATA[ code IN ]]>
			<foreach collection="array" item="item" open="(" close=")"
				separator=",">
				#{item}
			</foreach>
		</where>
	</delete>
	<!-- delete -->

	<!-- ajax -->
	<select id="getAjax" resultMap="main"
		resultType="com.itwillbs.domain.MaintenanceVO">
		SELECT m.code, m.reg_date,
		m.emp_code, e1.name AS emp_name,
		m.group_id,
		cm.group_name,
		m.code_id, cm.code_name,
		m.fac_code,
		f.group_id,
		cf.group_name,
		f.code_id, cf.group_name,
		f.line_code, l.name AS
		line_name,
		mt_subject, mt_content,
		m.complete,
		m.manager, e2.name AS
		manager_name,
		m.res_info, m.res_content,
		m.comp_date
		FROM FAC_MT m
		JOIN
		FAC_INFO f ON m.fac_code = f.code
		JOIN COMMON_CODE cm ON m.group_id =
		cm.group_id AND m.code_id = cm.code_id
		JOIN COMMON_CODE cf ON
		f.group_id = cf.group_id AND f.code_id =
		cf.code_id
		JOIN EMPLOYEES e1 ON
		m.emp_code = e1.code
		JOIN EMPLOYEES e2 ON m.manager = e2.code
		JOIN LINE
		l ON l.code = f.line_code
		<include refid="getSearch" />
		ORDER BY m.code ASC
	</select>
	<!-- ajax -->
</mapper>