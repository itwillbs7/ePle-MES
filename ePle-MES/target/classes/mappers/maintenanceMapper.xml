<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 미완성 -->
<!-- maintenanceMapper.xml -->
<mapper namespace="com.itwillbs.mapper.MaintenanceMapper">
	<resultMap type="com.itwillbs.domain.MaintenanceVO"
		id="maintenance">
		<result property="code" column="code" />
		<result property="reg_date" column="reg_date" />
		<result property="emp_code" column="emp_code" />
		<result property="fac_code" column="fac_code" />
		<result property="group_id" column="group_id"/>
		<result property="group_name" column="group_name"/>
		<result property="code_id" column="code_id"/>
		<result property="code_name" column="code_name"/>
		<result property="mt_subject" column="mt_subject" />
		<result property="mt_content" column="mt_content" />
		<result property="complete" column="complete" />
		<result property="manager" column="manager" />
		<result property="res_info" column="res_info" />
		<result property="res_content" column="res_content" />
		<result property="comp_date" column="comp_date" />
	</resultMap>
	<resultMap type="com.itwillbs.domain.RMResultVO"
		id="rmResult">
		<result property="emp" column="emp" />
		<result property="name" column="name" />
		<result property="count" column="count" />
	</resultMap>

	<!-- 보전 -->
	<!-- 입력 -->
	<insert id="insertMain">
		INSERT INTO FAC_MT (code, emp_code, fac_code, group_id, code_id, 
		mt_subject, mt_content)
		VALUES (#{code}, #{emp_code}, #{fac_code}, #{group_id}, #{code_id}, #{mt_subject}, #{mt_cotent})
	</insert>

	<!-- 수정 -->
	<update id="updateMaintenance">
		UPDATE FAC_MT
		<set>
			emp_code = #{emp_code}, fac_code = #{fac_code},
			mt_subject = #{mt_subject}, mt_content = #{mt_content}
		</set>
		<where>
			code = #{code}
		</where>
	</update>

	<!-- 삭제 -->
	<delete id="deleteMaintenance">
		DELETE FROM FAC_MT WHERE code IN 
		<foreach collection="array" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</delete>

	<sql id="maintenanceSearch">
		<where>
			<![CDATA[code = code ]]>
			<if test="search eq null">
				<![CDATA[AND active = TRUE ]]>
			</if>
			<if test="search neq null">
				<!-- 라디오 -->
				<if test="search.formRadio eq null">
				<![CDATA[AND complete = TRUE ]]>
				</if>
				<if test="search.formRadio neq null">
					<choose>
						<when test="search.formRadio.toString() eq 'true'">
							<![CDATA[AND complete = TRUE ]]>
						</when>
						<when test="search.formRadio.toString() eq 'false'">
							<![CDATA[AND complete = FALSE ]]>
						</when>
					</choose>
				</if>
				<!-- 라디오 -->
				<!-- 기본 검색 -->
				<if test="search.searchKeyword neq null">
					<choose>
						<when test="search.searchCategory.toString() eq null">
							<![CDATA[
								AND (code LIKE '%'||#{search.searchKeyword}||'%' OR 
								emp_code LIKE '%'||#{search.searchKeyword}||'%' OR 
								fac_code LIKE '%'||#{search.searchKeyword}||'%' OR 
								manager LIKE '%'||#{search.searchKeyword}||'%' OR 
								res_info LIKE '%'||#{searchKeyword}||'%') 
							]]>
						</when>
						<when test="search.searchCategory.toString() eq 'index'">
							<![CDATA[
								AND code LIKE '%'||#{search.searchKeyword}||'%' 
							]]>
						</when>
						<when test="search.searchCategory.toString() eq 'emp_code'">
							<![CDATA[
								AND emp_code LIKE '%'||#{search.searchKeyword}||'%' 
							]]>
						</when>
						<when test="search.searchCategory.toString() eq 'fac_code'">
							<![CDATA[
								AND fac_code LIKE '%'||#{search.searchKeyword}||'%' 
							]]>
						</when>
						<when test="search.searchCategory.toString() eq 'manager'">
							<![CDATA[
								AND manager LIKE '%'||#{search.searchKeyword}||'%' 
							]]>
						</when>
						<when test="search.searchCategory.toString() eq 'res_info'">
							<![CDATA[
								AND res_info LIKE '%'||#{searchKeyword}||'%' 
							]]>
						</when>
					</choose>
				</if>
				<!-- 기본 검색 -->
				<!-- check box -->
				<if test="search.formCheck neq null">
				<![CDATA[AND code REGEXP]]>
					<foreach collection="search.formCheck" item="item"
						index="index" open="'" close="'" separator="|">
						#{item}
					</foreach>
				</if>
				<!-- check box -->
				<!-- date -->
				<if test="search.date neq null and search.date.toString() neq ''">
				<![CDATA[
					AND regdate = #{search.date}
				]]>
				</if>
				<!-- date -->
				<!-- date between -->
				<if
					test="search.betweenDateLeft neq null and 
				search.betweenDateLeft.toString() neq '' and
				search.betweenDateRight neq null and
				search.betweenDateRight.toString() neq ''">
					<![CDATA[
					AND regdate BETWEEN
					#{search.betweenDateLeft} AND
					#{search.betweenDateRight}
					]]>
				</if>
				<!-- date between -->
			</if>
			<!-- searchVO not null -->
		</where>
	</sql>
	<select id="getMaintenanceCount" resultType="int">
		<![CDATA[
			SELECT COUNT(*) FROM FAC_MT
		]]>
		<include refid="maintenanceSearch" />
	</select>

	<select id="getMaintenanceList"
		resultType="com.itwillbs.domain.MaintenanceVO" resultMap="maintenance">
		<![CDATA[
			SELECT * FROM FAC_MT
		]]>
		<include refid="maintenanceSearch" />
		<![CDATA[
			ORDER BY reg_date 
			LIMIT #{cri.page}, #{cri.pageSize}
		]]>
	</select>
	
	<select id="MaintenanceDetail">
		SELECT * FROM FAC_MT WHERE code = #{code}
	</select>
	<!-- 보전 -->
	
	<!-- 설비 detail -->
	<select id="getFacilityList" 
		resultType="com.itwillbs.domain.MaintenanceVO" resultMap="maintenance">
		SELECT * FROM FAC_MT WHERE fac_code = #{code} AND code NOT LIKE '%DM%' 
		ORDER BY code DESC LIMIT 0, 10
	</select>
	<!-- 설비 detail -->

	<!-- 일상보전 -->
	<insert id="insertRM">
		INSERT INTO FAC_MT (code, emp_code, fac_code, group_id, code_id, 
		mt_subject, mt_content, complete)
		VALUES (#{code}, #{emp_code}, #{fac_code}, #{group_id}, #{code_id}, #{mt_subject}, #{mt_cotent},
		true)
	</insert>

	<!-- 일상 보전 COUNT LIST(직원별) -->
	<select id="getRMCount"
		resultType="com.itwillbs.domain.RMResultVO" resultMap="rmResult">
		select
		f.emp_code as emp, e.name, count(emp_code) as count FROM FAC_MT f
		join EMPLOYEES e on f.emp_code = e.code
		WHERE DATE(f.reg_date) = NOW() AND
		f.code like 'RM%' GROUP BY f.emp_code
	</select>

	<select id="getRMList">
		SELECT * FROM FAC_MT WHERE emp_code = #{emp} and
		DATE(reg_date) = NOW() AND code like 'RM%' ORDER BY code
	</select>

	<select id="dailyRMCount">
		SELECT count(*) FROM FAC_MT WHERE DATE(reg_date) =
		NOW() AND code like 'RM%' AND emp_id = #{emp_id}
	</select>
	<!-- 일상보전 -->
	
	<!-- 보전 결과 -->
	<select id="">
		
	</select>
	<!-- 보전 결과 -->
</mapper>