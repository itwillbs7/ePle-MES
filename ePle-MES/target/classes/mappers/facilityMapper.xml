<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- facilityMapper.xml -->
<mapper namespace="com.itwillbs.mapper.FacilityMapper">
	<!-- resultMap -->
	<!-- 설비 -->
	<resultMap type="com.itwillbs.domain.FacilityVO"
		id="facility">
		<result property="code" column="code" />
		<result property="group_id" column="group_id"/>
		<result property="code_id" column="code_id"/>
		<result property="group_name" column="group_name"/>
		<result property="code_name" column="code_name"/>
		<result property="name" column="name" />
		<result property="model" column="model" />
		<result property="client_code" column="client_code"/>
		<result property="client_name" column="client_name"/>
		<result property="purchase_date" column="purchase_date" />
		<result property="inprice" column="inprice" />
		<result property="line_code" column="line_code" />
		<result property="line_name" column="line_name"/>
		<result property="uph" column="uph" />
		<result property="active" column="active" />
	</resultMap>
	<!-- 설비 -->
	<!-- resultMap -->

	<select id="getFacility" resultType="com.itwillbs.domain.FacilityVO" resultMap="facility">
		SELECT f.code, co.group_name, co.code_name, f.name, f.model,  
		cli.name as client_name, f.purchase_date, inprice, l.name as line_name, f.uph, f.active
		FROM FAC_INFO f
		JOIN COMMON_CODE co ON f.group_id = co.group_id AND f.code_id = co.code_id 
		LEFT OUTER JOIN CLIENT cli ON cli.code = f.client_code 
		LEFT OUTER JOIN LINE l ON l.code = f.line_code
		WHERE f.code = #{code}
	</select>

	<!-- 상세 검색 -->
	<sql id="facilitySearch">
		<where>
			<choose>
				<when test="search.formRadio eq null">
					<![CDATA[f.active = true ]]>
				</when>
				<when test="search.formRadio.toString() eq 'all'">
					<![CDATA[f.code = code ]]>
				</when>
				<when test="search.formRadio.toString() eq 'true'">
					<![CDATA[f.active = true ]]>
				</when>
				<when test="search.formRadio.toString() eq 'false'">
					<![CDATA[f.active = false ]]>
				</when>
			</choose>
			<choose>
				<when test="search.isnull == true">
					<if test="search.isajax == true">
						AND f.purchase_date BETWEEN DATE_SUB(NOW(), INTERVAL 1 MONTH) AND NOW() 
					</if>
				</when>
				<when test="search.isnull == false">
					<!-- 기본 검색 -->
					<if
						test="search.searchKeyword neq null and search.searchKeyword.toString() neq ''">
						<choose>
							<when test="search.index == -1">
								<foreach collection="search.searchMenu" item="item"
									open="AND (" close=")" separator=" OR ">
									${item} LIKE
									'%${search.searchKeyword}%'
								</foreach>
							</when>
							<when test="search.index != -1">
						<![CDATA[
							AND ${search.searchMenu[search.index]} LIKE '%${search.searchKeyword}%' 
						]]>
							</when>
						</choose>
					</if>
					<!-- 기본 검색 -->
					<!-- check box -->
					<if test="search.formCheck neq null">
						<![CDATA[ AND f.group_id IN ]]>
						<foreach collection="search.formCheck" item="item"
							index="index" open="(" close=")" separator=",">
							#{item}
						</foreach>
					</if>
					<!-- check box -->
					<!-- date -->
					<choose>
						<when
							test="search.date neq null and search.date.toString() neq ''">
							<![CDATA[
								AND f.purchase_date = #{search.date}
							]]>
						</when>
						<otherwise>
							<!-- date between -->
							<choose>
								<when
									test="search.betweenDateLeft neq null and search.betweenDateLeft.toString() neq '' and search.betweenDateRight neq null and search.betweenDateRight.toString() neq ''">
											<![CDATA[
												AND f.purchase_date BETWEEN 
												#{search.betweenDateLeft} AND 
												#{search.betweenDateRight} 
											]]>
								</when>
								<when
									test="search.betweenDateLeft neq null and search.betweenDateLeft.toString() neq ''">
											<![CDATA[
												AND f.purchase_date >= #{search.betweenDateLeft}
											]]>
								</when>
								<when
									test="search.betweenDateRight neq null and search.betweenDateRight.toString() neq ''">
											<![CDATA[
												AND f.purchase_date <= #{search.betweenDateRight}
											]]>
								</when>
							</choose>
							<!-- date between -->
						</otherwise>
					</choose>
					<!-- date -->
				</when>
			</choose>
		</where>
	</sql>
	<!-- 상세 검색 -->

	<!-- 추가 -->
	<insert id="insertFacility">
		<choose>
			<when test="group_id.toString() eq 'FACPRO'">
				INSERT INTO FAC_INFO (code, group_id, code_id, name, model, 
				purchase_date, inprice, uph, line_code)
				VALUES (#{code}, #{group_id}, #{code_id}, #{name},
				#{model}, #{purchase_date}, ${inprice}, ${uph}, #{line_code})
			</when>
			<otherwise>
				INSERT INTO FAC_INFO (code, group_id, code_id, name, model, 
				purchase_date, inprice, line_code)
				VALUES (#{code}, #{group_id}, #{code_id}, #{name},
				#{model}, #{purchase_date}, ${inprice}, #{line_code})
			</otherwise>
		</choose>
	</insert>
	<!-- 추가 -->

	<!-- 최근 설비 검색 -->
	<select id="findLastFacility" resultType="String">
		SELECT code FROM FAC_INFO
		ORDER BY code DESC
		LIMIT 0, 1
	</select>
	<!-- 최근 설비 검색 -->

	<!-- 수정 -->
	<update id="updateFacility">
		UPDATE FAC_INFO
		<set>
			active = #{active}, 
			group_id = #{group_id}, code_id = #{code_id}, 
			
		</set>
		<where>
			code = #{code}
		</where>
	</update>

	<!-- 삭제 -->
	<delete id="deleteFacility">
		DELETE FROM FAC_INFO
		<where>
			<![CDATA[ code IN ]]>
			<foreach collection="array" item="item" open="("
				close=")" separator=",">
				#{item}
			</foreach>
		</where>
	</delete>

	<!-- 개수 계산 -->
	<select id="getFacilityCount" resultType="int">
		<![CDATA[	
			SELECT COUNT(f.code)
			FROM FAC_INFO f
			JOIN COMMON_CODE co ON f.group_id = co.group_id AND f.code_id = co.code_id 
			LEFT OUTER JOIN CLIENT cli ON cli.code = f.client_code 
			LEFT OUTER JOIN LINE l ON l.code = f.line_code
		]]>
		<include refid="facilitySearch" />
	</select>

	<!-- 페이징 처리한 리스트 return -->
	<select id="getFacilityList"
		resultType="com.itwillbs.domain.FacilityVO" resultMap="facility">
		<![CDATA[
			SELECT f.code, co.group_name, co.code_name, 
			f.name, f.model, l.name as line_name 
			FROM FAC_INFO f 
			JOIN COMMON_CODE co ON f.group_id = co.group_id AND f.code_id = co.code_id 
			LEFT OUTER JOIN CLIENT cli ON cli.code = f.client_code 
			LEFT OUTER JOIN LINE l ON l.code = f.line_code
		]]>
		<include refid="facilitySearch" />
		<![CDATA[
		ORDER BY 
		]]>
		${search.eng[search.activeSortCategory]} ${search.sortValue}

		LIMIT ${cri.startPage}, ${cri.pageSize}
	</select>


	<!-- ajax 리턴 용 -->
	<select id="getExportList"
		resultType="com.itwillbs.domain.FacilityVO" resultMap="facility">
		<![CDATA[
			SELECT f.code, co.group_name, co.code_name, f.name, 
			f.model, cli.name as client_name, f.purchase_date, inprice, 
			l.name as line_name, f.uph
			FROM FAC_INFO f
			JOIN COMMON_CODE co ON f.group_id = co.group_id AND f.code_id = co.code_id 
			LEFT OUTER JOIN CLIENT cli ON cli.code = f.client_code 
			LEFT OUTER JOIN LINE l ON l.code = f.line_code
		]]>
		<include refid="facilitySearch" />
		<![CDATA[ ORDER BY code]]>
	</select>
	
	<select id="getLineList" resultType="com.itwillbs.domain.FacilityVO" resultMap="facility">
		SELECT code AS line_code, name AS line_name FROM LINE
	</select>
	
	<select id="getCommonCodeList" resultType="com.itwillbs.domain.FacilityVO" resultMap="facility">
		SELECT group_id, group_name, code_id, code_name from COMMON_CODE 
		WHERE group_id = #{group_id}
	</select>
	
	<select id="getFacManager" resultType="com.itwillbs.domain.FacilityVO" resultMap="facility">
		SELECT code, model, name FROM FAC_INFO 
		WHERE emp_code = #{emp_code}
	</select>
	
	<select id="getFacListManager" resultType="com.itwillbs.domain.FacilityVO" resultMap="facility">
		SELECT code, model, name FROM FAC_INFO
	</select>
</mapper>