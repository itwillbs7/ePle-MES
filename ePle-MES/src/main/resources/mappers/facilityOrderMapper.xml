<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- facilityOrderMapper.xml -->
<mapper namespace="com.itwillbs.mapper.FacilityOrderMapper">
	<resultMap type="com.itwillbs.domain.FacilityOrderVO" id="order">
		<result property="code" column="code"/>
		<result property="date" column="date"/>
		<result property="group_id" column="group_id"/>
		<result property="code_id" column="code_id" />
		<result property="group_name" column="group_name"/>
		<result property="code_name" column="code_name"/>
		<result property="client_code" column="client_code" />
		<result property="client_name" column="client_name" />
		<result property="amount" column="amount" />
		<result property="reg_date" column="reg_date"/>
		<result property="reg_emp" column="reg_emp"/>
		<result property="reg_name" column="reg_name"/>
		<result property="update_date" column="update_date"/>
		<result property="update_emp" column="update_emp"/>
		<result property="update_name" column="update_name"/>
		<result property="status" column="status"/>
	</resultMap>
	
	<select id="getOrderList" resultMap="order">
		SELECT o.code, o.date, o.group_id, o.code_id, com.group_name, 
		com.code_name, o.client_code, cli.client_name, amount, 
		o.reg_date, o.reg_emp, e1.name AS reg_name, 
		o.update_date, o.update_emp, e2.name AS update_name, 
		o.status
		FROM ORDERS o 
		JOIN CLIENT cli ON o.client_code = cli.code  
		JOIN EMPLOYEES e1 ON o.reg_emp = e1.code 
		JOIN EMPLOYEES e2 ON o.update_emp = e2.code 
		JOIN COMMON_CODE co ON o.group_id = co.group_id AND o.code_id = co.code_id 
		WHERE complete = FALSE AND o.group_id IN ('FACPRO', 'FACNPR', 'FACETC') 
		ORDER BY 
		${search.eng[search.activeSortCategory]} ${search.sortValue}

		LIMIT ${startPage}, ${cri.pageSize}
	</select>
	
	<select id="getOrder" resultMap="order" resultType="com.itwillbs.domain.FacilityOrderVO">
		SELECT * FROM ORDERS WHERE code = #{code}
	</select>
	
	<select id="getCommonList" resultMap="order" resultType="com.itwillbs.domain.FacilityOrderVO">
		SELECT group_id, code_id, group_name, code_name from COMMON_CODE 
		WHERE group_id = #{group_id}
	</select>
	
	<select id="getRecentCode" resultType="String">
		SELECT code FROM ORDERS WHERE date = NOW() ORDER BY code DESC LIMIT 0, 1
	</select>
	
	<insert id="insertOrder">
		INSERT INTO ORDERS (code, group_id, code_id, date, client_code, amount, status) 
		VALUES (#{code}, #{group_id}, #{code_id}, NOW(), #{client_code}, ${amount}, '신청')
	</insert>
	
	<!-- 수정 -->
	<!-- 클라이언트가 같을 때만 가능 -->
	<update id="updateOrder">
		UPDATE ORDERS 
		<set>
			group_id = #{group_id}, code_id = #{code_id}, amount = ${amount}
		</set>
		<where>
			code = #{code} AND client_code = #{client_code} 
			AND status = '신청'
		</where>
	</update>
	
	<delete id="deleteOrder">
		DELETE FROM ORDERS WHERE code IN 
		<foreach collection="codeList" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</delete>
</mapper>