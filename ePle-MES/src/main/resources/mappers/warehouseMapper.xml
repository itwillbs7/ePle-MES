<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  
  <!--warehouseMapper.xml -->
  <mapper namespace="com.itwillbs.mapper.WarehouseMapper">
  
  	<resultMap type="com.itwillbs.domain.WarehouseVO" id="warehouse">
		<result property="wh_code" column="code"/>
		<result property="location" column="location"/>
		<result property="group_id" column="group_id"/>
		<result property="group_name" column="group_name"/>
		<result property="manager" column="manager"/>
		<result property="mng_phone" column="mng_phone"/>
		<result property="active" column="active"/>
		<result property="emp_code" column="code"/>
		<result property="name" column="name"/>
		<result property="phone" column="phone"/>
	</resultMap>

	
	<!-- 창고 목록, 창고 검색 -->
	<select id="selectWarehouseList" parameterType="hashMap" resultMap="warehouse">
    	SELECT w.code, w.location, w.group_id, w.group_name, e.code, e.name, e.phone, w.active
    	FROM WAREHOUSE w 
    	JOIN EMPLOYEES e 
    	ON w.manager = e.code
		<where>
			<if test="searchCode != null or searchName != null">
			<if test="searchCode != null">
				w.code LIKE CONCAT('%', #{searchCode}, '%')
			</if>
			<if test="searchCode != null and searchName != null">
				AND
			</if>
			<if test="searchName != null">
				e.code LIKE CONCAT('%', #{searchName}, '%')
			</if>
			</if>
    	</where>
    	ORDER BY CAST(SUBSTRING(w.code, 4) AS UNSIGNED) DESC	<!-- 코드 정하면 수정하기 -->
    	LIMIT #{cri.startPage}, #{cri.pageSize}
	</select>

	<!-- 모든 창고 수 -->
	<select id="countWarehouse" parameterType="hashMap" resultType="int">
		SELECT count(*) 
		FROM WAREHOUSE
		<where>
			<if test="searchCode != null or searchName != null">
			<if test="searchCode != null">
				code LIKE CONCAT('%', #{searchCode}, '%')
			</if>
			<if test="searchCode != null and searchName != null">
				AND
			</if>
			<if test="searchName != null">
				manager LIKE CONCAT('%', #{searchName}, '%')
			</if>
			</if>
		</where>
	</select>
	
	<!-- 사원 검색 팝업 -->
	<select id="SearchEmployees" parameterType="hashMap" resultMap="warehouse">
		SELECT code, name
		FROM EMPLOYEES
		WHERE dep_id = '자재부'	
			<if test="empCode != null or empName != null">
			<if test="empCode != null">
				AND code LIKE CONCAT('%', #{empCode}, '%')
			</if>
			<if test="empCode != null and empName != null">
				AND
			</if>
			<if test="empName != null">
				name LIKE CONCAT('%', #{empName}, '%')
			</if>
			</if>
    	LIMIT #{cri.startPage}, #{cri.pageSize}
	</select>	
	
	<!-- 모든 사원 수 -->
	<select id="countEmployees" parameterType="hashMap" resultType="int">
		SELECT count(*) 
		FROM EMPLOYEES
		WHERE dep_id = '자재부'	
			<if test="empCode != null or empName != null">
			<if test="empCode != null">
				AND code LIKE CONCAT('%', #{empCode}, '%')
			</if>
			<if test="empCode != null and empName != null">
				AND
			</if>
			<if test="empName != null">
				name LIKE CONCAT('%', #{empName}, '%')
			</if>
			</if>
	</select>

	<!-- 창고 삭제 -->
	<select id="getDelInfo" resultMap="warehouse">
    	SELECT w.code, w.location, w.group_id, w.group_name, e.code, e.name, e.phone, w.active
    	FROM WAREHOUSE w 
    	JOIN EMPLOYEES e 
    	ON w.manager = e.code
		WHERE w.code IN
		<foreach collection="code_arr" item="item" open="(" close=")" separator=",">
			#{item}
		 </foreach>
	</select>
	
	<delete id="deleteWarehouse" parameterType="hashmap">
		DELETE FROM WAREHOUSE WHERE code IN
		<foreach collection="code_arr" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</delete>
	
	
	
	
	
  </mapper>